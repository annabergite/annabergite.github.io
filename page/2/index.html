<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="记录博客与成长,Java，架构">
<meta property="og:type" content="website">
<meta property="og:title" content="艾迪的技术之路">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="艾迪的技术之路">
<meta property="og:description" content="记录博客与成长,Java，架构">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="annabergite">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>艾迪的技术之路</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.7.0/mermaid.min.js","integrity":"sha256-4+IKDqhZ/sXjc8Wtl2/MsxI4e0s1KpEVdbEP7V/Lz8U="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">艾迪的技术之路</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录博客与成长</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">annabergite</p>
  <div class="site-description" itemprop="description">记录博客与成长,Java，架构</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E5%BC%80%E5%8F%91/15.easy%20excel%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E4%BB%BB%E6%84%8F%E8%A1%A8%E7%9A%84Excel%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E5%BC%80%E5%8F%91/15.easy%20excel%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E4%BB%BB%E6%84%8F%E8%A1%A8%E7%9A%84Excel%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/" class="post-title-link" itemprop="url">easy excel实现一个接口任意表的Excel导入导出</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:36:31 / 修改时间：23:07:37" itemprop="dateCreated datePublished" datetime="2025-07-12T12:36:31+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Java的web开发需要excel的导入导出工具，所以需要一定的工具类实现，如果是使用easypoi、Hutool导入导出excel，会非常的损耗内存，因此可以尝试使用easyexcel解决大数据量的数据的导入导出，且可以通过Java8的函数式编程解决该问题。</p>
<p>使用easyexcel，虽然不太会出现OOM的问题，但是如果是大数据量的情况下也会有一定量的内存溢出的风险，所以我打算从以下几个方面优化这个问题：</p>
<ul>
<li>使用Java8的函数式编程实现低代码量的数据导入</li>
<li>使用反射等特性实现单个接口导入任意excel</li>
<li>使用线程池实现大数据量的excel导入</li>
</ul>
<!---->
<ul>
<li>通过泛型实现数据导出</li>
</ul>
<h2 id="maven导入">maven导入</h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--EasyExcel相关依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easyexcel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="使用泛型实现对象的单个Sheet导入">使用泛型实现对象的单个Sheet导入</h2>
<h3 id="先实现一个类，用来指代导入的特定的对象">先实现一个类，用来指代导入的特定的对象</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(&quot;stu_info&quot;)</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;学生信息&quot;)</span></span><br><span class="line"><span class="comment">//@ExcelIgnoreUnannotated 没有注解的字段都不转换</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StuInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 姓名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 设置字体，此处代表使用斜体</span></span><br><span class="line"><span class="comment">//    @ContentFontStyle(italic = BooleanEnum.TRUE)</span></span><br><span class="line">    <span class="comment">// 设置列宽度的注解,注解中只有一个参数value，value的单位是字符长度，最大可以设置255个字符</span></span><br><span class="line">    <span class="meta">@ColumnWidth(10)</span></span><br><span class="line">    <span class="comment">// @ExcelProperty 注解中有三个参数value,index,converter分别代表表名，列序号，数据转换方式</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;姓名&quot;)</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;姓名&quot;,order = 0)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;姓名&quot;,index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 年龄</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @ExcelIgnore不将该字段转换成Excel</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;年龄&quot;,order = 1)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;年龄&quot;)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;年龄&quot;,index = 2)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 身高</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//自定义格式-位数</span></span><br><span class="line"><span class="comment">//    @NumberFormat(&quot;#.##%&quot;)</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;身高&quot;,order = 2)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;身高&quot;)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;身高&quot;,index = 4)</span></span><br><span class="line">    <span class="keyword">private</span> Double tall;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自我介绍</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;自我介绍&quot;,order = 3)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;自我介绍&quot;)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;自我介绍&quot;,index = 3,ignore = true)</span></span><br><span class="line">    <span class="keyword">private</span> String selfIntroduce;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;图片信息&quot;,order = 4)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;图片信息&quot;)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;图片信息&quot;,ignore = true)</span></span><br><span class="line">    <span class="keyword">private</span> Blob picture;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;性别&quot;,order = 5)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;性别&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 入学时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//自定义格式-时间格式</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(&quot;yyyy-MM-dd HH:mm:ss:&quot;)</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;入学时间&quot;,order = 6)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;入学时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String intake;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出生日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;出生日期&quot;,order = 7)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;出生日期&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String birthday;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="重写ReadListener接口">重写ReadListener接口</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadDataListener</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">ReadListener</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每隔5条存储数据库，实际使用中可以100条，然后清理list ，方便内存回收</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BATCH_COUNT</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; cachedDataList = ListUtils.newArrayListWithExpectedSize(BATCH_COUNT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Predicate用于过滤数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Predicate&lt;T&gt; predicate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用持久层批量保存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Consumer&lt;Collection&lt;T&gt;&gt; consumer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UploadDataListener</span><span class="params">(Predicate&lt;T&gt; predicate, Consumer&lt;Collection&lt;T&gt;&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.predicate = predicate;</span><br><span class="line">        <span class="built_in">this</span>.consumer = consumer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UploadDataListener</span><span class="params">(Consumer&lt;Collection&lt;T&gt;&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.consumer = consumer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果使用了spring,请使用这个构造方法。每次创建Listener的时候需要把spring管理的类传进来</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> demoDAO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个每一条数据解析都会来调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    one row value. Is is same as &#123;<span class="doctag">@link</span> AnalysisContext#readRowHolder()&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(T data, AnalysisContext context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (predicate != <span class="literal">null</span> &amp;&amp; !predicate.test(data)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cachedDataList.add(data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 达到BATCH_COUNT了，需要去存储一次数据库，防止数据几万条数据在内存，容易OOM</span></span><br><span class="line">        <span class="keyword">if</span> (cachedDataList.size() &gt;= BATCH_COUNT) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 执行具体消费逻辑</span></span><br><span class="line">                consumer.accept(cachedDataList);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                log.error(<span class="string">&quot;Failed to upload data!data=&#123;&#125;&quot;</span>, cachedDataList);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 存储完成清理 list</span></span><br><span class="line">            cachedDataList = ListUtils.newArrayListWithExpectedSize(BATCH_COUNT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有数据解析完成了 都会来调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterAllAnalysed</span><span class="params">(AnalysisContext context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里也要保存数据，确保最后遗留的数据也存储到数据库</span></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(cachedDataList)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 执行具体消费逻辑</span></span><br><span class="line">                consumer.accept(cachedDataList);</span><br><span class="line">                log.info(<span class="string">&quot;所有数据解析完成！&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                log.error(<span class="string">&quot;Failed to upload data!data=&#123;&#125;&quot;</span>, cachedDataList);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 抛出自定义的提示信息</span></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BizException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Controller层的实现">Controller层的实现</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;只需要一个readListener，解决全部的问题&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;String&gt; <span class="title function_">aListener4AllExcel</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            EasyExcel.read(file.getInputStream(),</span><br><span class="line">                            StuInfo.class,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">UploadDataListener</span>&lt;StuInfo&gt;(</span><br><span class="line">                                    list -&gt; &#123;</span><br><span class="line">                                        <span class="comment">// 校验数据</span></span><br><span class="line"><span class="comment">//                                        ValidationUtils.validate(list);</span></span><br><span class="line">                                        <span class="comment">// dao 保存···</span></span><br><span class="line">                                        <span class="comment">//最好是手写一个，不要使用mybatis-plus的一条条新增的逻辑</span></span><br><span class="line">                                        service.saveBatch(list);</span><br><span class="line">                                        log.info(<span class="string">&quot;从Excel导入数据一共 &#123;&#125; 行 &quot;</span>, list.size());</span><br><span class="line">                                    &#125;))</span><br><span class="line">                    .sheet()</span><br><span class="line">                    .doRead();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line">            log.error(<span class="string">&quot;导入失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R.success(<span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>但是这种方式只能实现已存对象的功能实现，如果要新增一种数据的导入，那我们需要怎么做呢？</p>
<p>可以通过读取成Map，根据顺序导入到数据库中。</p>
<h2 id="通过实现单个Sheet中任意一种数据的导入">通过实现单个Sheet中任意一种数据的导入</h2>
<h3 id="Controller层的实现-2">Controller层的实现</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@ApiOperation(&quot;只需要一个readListener，解决全部的问题&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/listenMapDara&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;String&gt; <span class="title function_">listenMapDara</span><span class="params">(<span class="meta">@ApiParam(value = &quot;表编码&quot;, required = true)</span></span></span><br><span class="line"><span class="params">                                   <span class="meta">@NotBlank(message = &quot;表编码不能为空&quot;)</span></span></span><br><span class="line"><span class="params">                                   <span class="meta">@RequestParam(&quot;tableCode&quot;)</span> String tableCode,</span></span><br><span class="line"><span class="params">                                   <span class="meta">@ApiParam(value = &quot;上传的文件&quot;, required = true)</span></span></span><br><span class="line"><span class="params">                                   <span class="meta">@NotNull(message = &quot;上传文件不能为空&quot;)</span> MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//根据tableCode获取这张表的字段，可以作为insert与剧中的信息</span></span><br><span class="line">            EasyExcel.read(file.getInputStream(),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">NonClazzOrientedListener</span>(</span><br><span class="line">                                    list -&gt; &#123;</span><br><span class="line">                                        <span class="comment">// 校验数据</span></span><br><span class="line"><span class="comment">//                                        ValidationUtils.validate(list);</span></span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// dao 保存···</span></span><br><span class="line">                                        log.info(<span class="string">&quot;从Excel导入数据一共 &#123;&#125; 行 &quot;</span>, list.size());</span><br><span class="line">                                    &#125;))</span><br><span class="line">                    .sheet()</span><br><span class="line">                    .doRead();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;导入失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R.success(<span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="重写ReadListener接口-2">重写ReadListener接口</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NonClazzOrientedListener</span> <span class="keyword">implements</span> <span class="title class_">ReadListener</span>&lt;Map&lt;Integer, String&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每隔5条存储数据库，实际使用中可以100条，然后清理list ，方便内存回收</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BATCH_COUNT</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;Object&gt;&gt; rowsList = ListUtils.newArrayListWithExpectedSize(BATCH_COUNT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; rowList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Predicate用于过滤数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Predicate&lt;Map&lt;Integer, String&gt;&gt; predicate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用持久层批量保存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Consumer&lt;List&gt; consumer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NonClazzOrientedListener</span><span class="params">(Predicate&lt;Map&lt;Integer, String&gt;&gt; predicate, Consumer&lt;List&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.predicate = predicate;</span><br><span class="line">        <span class="built_in">this</span>.consumer = consumer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NonClazzOrientedListener</span><span class="params">(Consumer&lt;List&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.consumer = consumer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加deviceName标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Map&lt;Integer, String&gt; row, AnalysisContext analysisContext)</span> &#123;</span><br><span class="line">        consumer.accept(rowsList);</span><br><span class="line">        rowList.clear();</span><br><span class="line">        row.forEach((k, v) -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;key is &#123;&#125;,value is &#123;&#125;&quot;</span>, k, v);</span><br><span class="line">            rowList.add(v == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : v);</span><br><span class="line">        &#125;);</span><br><span class="line">        rowsList.add(rowList);</span><br><span class="line">        <span class="keyword">if</span> (rowsList.size() &gt; BATCH_COUNT) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;执行存储程序&quot;</span>);</span><br><span class="line">            log.info(<span class="string">&quot;rowsList is &#123;&#125;&quot;</span>, rowsList);</span><br><span class="line">            rowsList.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterAllAnalysed</span><span class="params">(AnalysisContext analysisContext)</span> &#123;</span><br><span class="line">        consumer.accept(rowsList);</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(rowsList)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;执行最后的程序&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;rowsList is &#123;&#125;&quot;</span>, rowsList);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                log.error(<span class="string">&quot;Failed to upload data!data=&#123;&#125;&quot;</span>, rowsList);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 抛出自定义的提示信息</span></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BizException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                rowsList.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这种方式可以通过把表中的字段顺序存储起来，通过配置数据和字段的位置实现数据的新增，那么如果出现了导出数据模板/手写excel的时候顺序和导入的时候顺序不一样怎么办？</p>
<p>可以通过读取header进行实现，通过表头读取到的字段，和数据库中表的字段进行比对，只取其中存在的数据进行排序添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里会一行行的返回头</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeHead</span><span class="params">(Map&lt;Integer, ReadCellData&lt;?&gt;&gt; headMap, AnalysisContext context)</span> &#123;</span><br><span class="line">        <span class="comment">//该方法必然会在读取数据之前进行</span></span><br><span class="line">        Map&lt;Integer, String&gt; columMap = ConverterUtils.convertToStringMap(headMap, context);</span><br><span class="line">        <span class="comment">//通过数据交互拿到这个表的表头</span></span><br><span class="line"><span class="comment">//        Map&lt;String,String&gt; columnList=dao.xxxx();</span></span><br><span class="line">        Map&lt;String, String&gt; columnList = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        columMap.forEach((key, value) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (columnList.containsKey(value)) &#123;</span><br><span class="line">                filterList.add(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//过滤到了只存在表里面的数据，顺序就不用担心了，可以直接把filterList的数据用于排序，可以根据mybatis做一个动态sql进行应用</span></span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;解析到一条头数据:&#123;&#125;&quot;</span>, JSON.toJSONString(columMap));</span><br><span class="line">        <span class="comment">// 如果想转成成 Map&lt;Integer,String&gt;</span></span><br><span class="line">        <span class="comment">// 方案1： 不要implements ReadListener 而是 extends AnalysisEventListener</span></span><br><span class="line">        <span class="comment">// 方案2： 调用 ConverterUtils.convertToStringMap(headMap, context) 自动会转换</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那么这些问题都解决了，如果出现大数据量的情况，如果要极大的使用到cpu，该怎么做呢？</p>
<p>可以尝试使用线程池进行实现</p>
<h2 id="使用线程池进行多线程导入大量数据">使用线程池进行多线程导入大量数据</h2>
<p>Java中线程池的开发与使用与原理我可以单独写一篇文章进行讲解，但是在这边为了进行好的开发我先给出一套固定一点的方法。</p>
<p>由于ReadListener不能被注册到IOC容器里面，所以需要在外面开启</p>
<p>详情可见<a target="_blank" rel="noopener" href="https://juejin.cn/post/7251566038524133436?searchId=2024041212522037CB9A6B24BDAA8953E7">Spring Boot通过EasyExcel异步多线程实现大数据量Excel导入,百万数据30秒</a></p>
<h2 id="通过泛型实现对象类型的导出">通过泛型实现对象类型的导出</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">commonExport</span><span class="params">(String fileName, List&lt;T&gt; data, Class&lt;T&gt; clazz, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtil.isEmpty(data)) &#123;</span><br><span class="line">        data = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置标题</span></span><br><span class="line">    fileName = URLEncoder.encode(fileName, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    response.setContentType(<span class="string">&quot;application/vnd.ms-excel&quot;</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Content-disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + fileName + <span class="string">&quot;.xlsx&quot;</span>);</span><br><span class="line">    EasyExcel.write(response.getOutputStream()).head(clazz).sheet(<span class="string">&quot;sheet1&quot;</span>).doWrite(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接使用该方法可以作为公共的数据的导出接口</p>
<p>如果想要动态的下载任意一组数据怎么办呢？可以使用这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportFreely</span><span class="params">(String fileName, List&lt;List&lt;Object&gt;&gt; data, List&lt;List&lt;String&gt;&gt; head, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isEmpty(data)) &#123;</span><br><span class="line">            data = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置标题</span></span><br><span class="line">        fileName = URLEncoder.encode(fileName, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/vnd.ms-excel&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + fileName + <span class="string">&quot;.xlsx&quot;</span>);</span><br><span class="line">        EasyExcel.write(response.getOutputStream()).head(head).sheet(<span class="string">&quot;sheet1&quot;</span>).doWrite(data);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>什么？不仅想一个接口展示全部的数据与信息，还要增加筛选条件？这个后期我可以单独写一篇文章解决这个问题。</p>
<p>今天的分享就到这里了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E5%BC%80%E5%8F%91/14.%E7%BB%99%E5%85%AC%E5%8F%B8%E6%8E%A5%E5%85%A5%E4%BA%86dynamic-tp%EF%BC%8C%E6%88%91%E6%98%AF%E8%BF%99%E4%B9%88%E5%81%9A%E7%9A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E5%BC%80%E5%8F%91/14.%E7%BB%99%E5%85%AC%E5%8F%B8%E6%8E%A5%E5%85%A5%E4%BA%86dynamic-tp%EF%BC%8C%E6%88%91%E6%98%AF%E8%BF%99%E4%B9%88%E5%81%9A%E7%9A%84/" class="post-title-link" itemprop="url">实际使用动态线程池框架dynamic-tp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:33:28 / 修改时间：23:16:11" itemprop="dateCreated datePublished" datetime="2025-07-12T12:33:28+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[TOC]</p>
<h2 id="1-背景">1 背景</h2>
<p>前段时间新入职了一家公司，组长看我已经有点开发年头了，委任给我一个大活，想让我可以监控任务队列，以及线程池的其他参数，如果有修改、监控到异常则需要进行告警，并且支持实施修改线程池参数。</p>
<h2 id="2-明确任务范围">2 明确任务范围</h2>
<p>首先并不是为了强行使用动态线程池框架而使用他，使用它的原因是我们的需求就是：</p>
<ul>
<li>实时监控线程池参数</li>
<li>修改实时监控线程池参数的一些状态</li>
<li>以及进行及时的告警</li>
<li>做到实时修改我们的线程池参数</li>
</ul>
<p>虽然JDK8可以做到通过方法直接修改线程池参数。但是如果自己手写的话则会浪费很多时间。为了避免重复造轮子，我决定及时使用开源框架。</p>
<h3 id="2-1-技术选型">2.1 技术选型</h3>
<p>当然也不是非得使用dynamic-tp不可，首先我们需要看行业中有没有合适的框架或者思路供我们选择，我们发现了这个框架</p>
<p><img src="https://p0.meituan.net/travelcube/6c0091e92e90f50f89fd83f3b9eb5472135718.png" alt="图18 动态化线程池功能架构"></p>
<p>这个美团技术团队对动态线程池该做什么的功能架构，这刚好和我们的需求不谋而合</p>
<p>此时行业中比较好的开源框架有这两个，dynamic-tp和hippo4j，hoppo4j架构是C/S模式，所以需要新增一个hippo4j服务端，那么如果需要一个线上配置环境修改配置的话，那么hippo4j会好一点，我们目前没有这个需求，所以会使用dynamic-tp，直接引用即可，并且通过集成到自己的配置中心就好了（当然看业务需求是怎么样的，毕竟hippo4j在GitHub上的star数量比dynamictp多一些）</p>
<h3 id="2-2-引入dynamic-tp">2.2 引入dynamic-tp</h3>
<p>（具体请看dynamic-tp的官网操作）</p>
<ol start="0">
<li>我们是使用的nacos作为配置中心和服务发现中心，所以需要引入对应的nacos包</li>
<li>dynamic-tp只能使用注解强化Java和spring的自带线程池，所以我们只使用配置文件的方式将业务需要使用的线程池放到Dtp注册器里面</li>
<li>在原有的需要放入线程操作的代码中放一下对应的Dtp注册器里面的线程池进行替换</li>
</ol>
<h2 id="2-引入时产生的问题">2.引入时产生的问题</h2>
<ol start="0">
<li>
<p>我们需要自定义告警信息，如果使用自带的wechat提醒或者钉钉提醒，只是通过机器人进行提醒，我们需要使用自己的API</p>
<p>我们使用了自己的API进行了解决，并且使用Java SPI进行了服务提供</p>
</li>
<li>
<p>使用自定义告警信息，涉及到了API，但是自己的API需要从spring的IOC容器里面获取，但是自定义的告警通知是无法拿到的</p>
<p>一般公司都会有人对获取bean的工具类做封装，所以可以通过这种getBean()方式拿到了对应Bean</p>
</li>
<li>
<p>我们想使用自定义的拒绝策略</p>
<p>使用Java SPI进行了拒绝策略的自定义</p>
</li>
<li>
<p>使用dynamic-tp需要考虑到一些公共的修改，比如我们的wechat自定义提醒，自定义拒绝策略，每一次都引入再添加共同的代码文件比较麻烦</p>
<p>我们进行了二次封装，再二次封装的代码中加入了这些修改，这样其他微服务使用dynamic-tp框架时候可以直接使用我们的二次封装的框架</p>
<p>我们并没有使用@import等注解，而是在引入后使用ComponentScan注解主动扫描的</p>
</li>
</ol>
<h3 id="2-1-一些遗憾">2.1 一些遗憾</h3>
<ol start="0">
<li>使用的自定义告警、拒绝策略，则需要使用Java spi进行服务提供与发现，不能使用spring的自动装配</li>
<li>只有Java或者spring自带的线程池可以被使用注解强化，用处不大，反而是如果可以使用注解在ThreadPoolExecutor的话则对我们帮助很大</li>
</ol>
<p>当然，dynamic-tp本身我是很喜欢的，他帮我提前造好了轮子，提升了我们的开发效率。</p>
<h2 id="3-参数怎么跟随业务修改？">3.参数怎么跟随业务修改？</h2>
<p>线程池参数并不是一成不变的，后续肯定会随着业务的需要进行修改。修改之前需要考虑一下是否有资源没有用到，有时候就是会出现资源没有使用全（如LB没有重定向好）导致的资源紧张。</p>
<p>修改线程池参数一般只会修改核心线程数、最大线程数、任务队列这几个信息。线程池执行情况与任务类型相关性较大，IO 密集型和 CPU 密集型的任务运行起来的情况差异非常大，所以一般我们每个微服务会有两个线程池，一个用于做IO密集型，一个用于做CPU密集型任务，这两个线程池的参数调试肯定是不一样的</p>
<p>具体的方法有这几种：</p>
<ol start="0">
<li>
<p>根据经验猜</p>
</li>
<li>
<p>此处我放一张行业内比较认可的图片</p>
<p><img src="https://p0.meituan.net/travelcube/23a44974ff68a08261fb675242b83648181953.png" alt="img"></p>
<p>这几种方式见仁见智</p>
</li>
<li>
<p>根据方法二的调参进行修改，同时使用动态线程池实时监控线程池负载，如果线程池逐步正常，则表明修改后的参数可以满足业务需求</p>
</li>
</ol>
<h2 id="参考文章：">参考文章：</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://hippo4j.cn/">Hippo4J官网</a></li>
<li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html">Java线程池实现原理及其在美团业务中的实践</a></li>
<li><a target="_blank" rel="noopener" href="https://dynamictp.cn/">dynamic-tp官网</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?spm=a2c6h.12873639.article-detail.7.605b2645VLJDkw&amp;__biz=Mzg3NDA1MTgwNA==&amp;mid=2247484615&amp;idx=1&amp;sn=915be23f412f987ee0b73c7ba8f4813e&amp;chksm=ced7e574f9a06c6210d70699f1e9d2edfa8ab40851030381c8ee18b7e344fc77cfd13a27cda0&amp;scene=21#wechat_redirect">一文读懂线程池的实现原理</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1323851">动态调整线程池参数实践</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E7%94%9F%E6%B4%BB/1.2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E7%94%9F%E6%B4%BB/1.2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">2024年终总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:28:06 / 修改时间：23:16:11" itemprop="dateCreated datePublished" datetime="2025-07-12T12:28:06+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%94%9F%E6%B4%BB/" itemprop="url" rel="index"><span itemprop="name">生活</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="背景">背景</h2>
<p>我当前是一名普通的 Java 技术开发。人在杭州，目前的行业是安防行业，最近这段时间有想润的想法，有空位的可以加我投递与被投递。喜欢出去玩的同好也可以来找我，我比较喜欢读书，骑行，长跑，羽毛球，探店，其他的爱好我还在持续探索中。</p>
<h2 id="复盘">复盘</h2>
<p>今年年初还没有学习过目标管理，所以很多目标都没有实现。不过今年学习了，之后肯定可以更好的指定目标与实现目标</p>
<h2 id="跳槽">跳槽</h2>
<p>之前我在杭州某G端产品的企业中工作，22年毕业后一直在那边工作，但是这份工作其实更接近于项目外包，都是在重复重复，对于我而言完全没有什么提升的空间；这让我想到了之前在大学哲学课上老师讲的事情，人的一切发展都是有比较而来的，有近就有远，有宇宙之大就会有原子之小，看到了和我一个学校毕业的人有了很大的成就后，也开始催促我进行成长。因此我在24年4月成功跳槽到当前公司B，期间当然也投递了一些比较知名的厂子。不过因为大厂进不去，也越能证明我的离开的想法是正确的，是应当做的，在面试过程中，多因为我扒股准备的还</p>
<p>行，但是基本上没有很厉害的实战经验。因此在进入新的公司后，有了专业的软件开发流程，我通过积极参与工作，也有学到更多。公司中有了专门的运维团队和测试团队，并且也有同事准备专门的教案进行教课。DBA和ELK专门的同事也有，不像原先的公司，这些岗位要么没有，要么在某一个身兼多职的人身上。</p>
<p>后续只拿了 2 个滨江区的 offer，一个是电商行业的，一个是安防行业的，电商行业的其实是和一个子公司签合同，感觉有点怪，并且人还很少，只有 200 人的一个小公司，安防行业的那个有大概 5k 人，所以选择了入职安防厂子。</p>
<p>2024年基本上也就做了这几个事情：</p>
<ul>
<li>事件业务进行了重构改版高并发查询，出现了慢查询，修复了慢查询</li>
<li>套餐支持不同类型订阅人使用不同订阅设备</li>
<li>服务新增线程池监控告警，使用开源组件基础上又做了一层封装</li>
<li>新增事件呼叫业务，新增时间业务的高并发场景下的异步操作与回调操作</li>
<li>修复几十个已知的线上bug</li>
</ul>
<p>整个开发过程不是开发困难，而是需要走标准化的流程，导致需要做很多归档，以至于我的组长都嫌弃我慢吞吞的 😢 。基本上每天都要加班，我粗略算了下，每个月都要至少加班 45h，感觉长久以来不是好事，我的健康都受到了影响，头发都掉了 1/4 了，可能干一年我就走了。</p>
<p>公司里面使用的是内网电脑，且是B端业务，基本上不能有使用AI直接生成满足业务的代码，但是使用AI生成存储过程进行辅助还是可以的。</p>
<p>新公司使用的技术栈个人认为不是很新，并且如果想要改版，得先让运维、测试、自动化脚本部门服从你的安排进行打通，否则只是个人单纯的使用新功能不能让其他人信服。在新公司中学到了一些其他的知识。今年业务是有所长进，但是技术的话基本上没长进，甚至可能还不如去年，我很喜欢的一个 B 站 up原子能讲过，如果一年下来可以记录在简历里面的东西很少，那代表可能需要离开了，不过当前我学到的东西还是有一些的，我打算先苟上一段时间。</p>
<h1>尝试副业</h1>
<p>只做程序员是不行的，所以我也打算开启自己的副业之旅，不过当前营收额是0，今年上旬打算是通过写博客赚钱，现在只获得了26个粉丝，csdn上面有200个粉丝，距离可以靠写作赚钱还剩不到9800个。我打算是通过做自己喜欢的事情作为副业进行赚钱，我打算继续把这个事情作为我25年的目标。之前在休闲的公司的时候，一个月可以产出4篇，现在不行了，就算有灵感也没有很多时间查找资料进行整理思考产出了，7月的时候参加了活动，拿了个小小奖。有需要这个打折券的可以找我。</p>
<p><img src="https://hexo-1304698044.cos.ap-shanghai.myqcloud.com/blog/1d879a3efc5fd6ddcb7bf1e2007e6211.png" alt="null"><img src="https://cdn.nlark.com/yuque/0/2025/png/27175151/1737724416443-81635160-6982-41a8-b9e8-384d9e2ab4c1.png" alt="img"></p>
<p>当然还是有几篇稍微有一点人看，我先截个图在这里。</p>
<p><img src="https://hexo-1304698044.cos.ap-shanghai.myqcloud.com/blog/image-20241221223204733.png" alt="null"><img src="https://cdn.nlark.com/yuque/0/2025/png/27175151/1737724421381-3c5af002-93d0-4867-9431-ed871378bd36.png" alt="img"></p>
<p>后续我打算不只是做一个只写博客的人，后续我也得通过技术外包等方向发展自己的副业才行。</p>
<h2 id="学习">学习</h2>
<p>之前在前东家完全么有什么成长，但是在新公司还是比较培养人的，我也在其他新同事的影响下有了很多个人成长。</p>
<p>自从毕业后，22、23年我也没看过书（技术社科博客会看一点），但是24年我也有学到很多，也看了很多书。今年看了《领域驱动设计》、《优势谈判》、《高效能人士的7个习惯》、《Spring源码深度解析（第二版）》，这些书除了《领域驱动设计》，其他的书对我思想上帮助很大，同时也对于我在实际工作生活中也有很大帮助（《领域驱动设计》有些地方讲的太模糊，对于我的思维构建有点差距，后续我打算看下六边形架构和Cola架构）。我打算后续也多看一些书，帮助自己更好的工作学习生活。纸质书没读多少，但是电子书倒是一本接着一本的看，我现在只要是在地铁上或者是在路上都会看一眼电子书。后续我可能会开一个专栏专门记录一下阅读了哪些书籍，且应用了哪些，取得了什么成果，有什么失败的经历值得回溯。</p>
<p>本来打算今年11月参加高级软考，但是因为工作太忙忘记了，后续我打算学习一下精力管理，保证自己可以在工作之后可以学有余力的进行其他有用的社会活动。</p>
<p>算法做题有做一些，但是没有参加比赛，基本上是拿着大学学到的知识在练习（大学时候主要使用C++写算法，现在却主要在用java写代码），并且主要目的还是为了面试求职。</p>
<p><img src="https://hexo-1304698044.cos.ap-shanghai.myqcloud.com/blog/d5755ca60f4a6834081a9a3d76cf681f.png" alt="null"><img src="https://cdn.nlark.com/yuque/0/2025/png/27175151/1737724429352-1baff242-2e91-497a-aec1-06cce4753ced.png" alt="img"></p>
<p>今年我开始参加各种会议，也浅浅的认识了一些开发者，有些人很谦虚，有些人很开放，这些人都是我可以学习的榜样。参加会议和沙龙，今年主题最多的就是AIGC和cursor，也有人真正的把一些AIGC产品给落地了。</p>
<p>为了通勤我买了辆山地自行车，周末也会骑车到钱塘，滨江，萧山这边走走，平常去的多的地方是湘湖，今年的骑行虽然没让我减少很多体重，但是至少让我对于工作地方有了更好的认识与了解，好吃的地方我也变得一目了然了。 自从进了新公司后，我也搬家了，从快到苕溪的余杭那边搬到了滨江浦沿，从1300能租到30平的朝南带阳台的大房间到现在只有15平的1600的小房间，我都基本上没地方做饭了，一些炒菜我也不方便做，没地方施展拳脚，后面我就只买一些鸡肉和虾这类方便一点的食物来凑活，做饭频率虽然降低了，但是做饭厨具现在减少了很多，变相的让我不需要再去维护很多使用频率低的家具了。</p>
<h2 id="娱乐">娱乐</h2>
<p>我的一个爱好是玩点单机游戏，因此今年玩了1、赛博朋克2077：往日之影（DLC）2024年4月27日、2、艾尔登法环：黄金树之影（DLC） 2024年6月23日 3、黑神话悟空 2024年9月15日</p>
<p>目前有点想玩下永劫无间，不知道最近也没有额外的时间可以用于打游戏了。之前从朋友那边收了个PS5，也买了个血源诅咒的光盘，但是也没玩很长时间就放在那边吃灰了。最近血源诅咒还出了 PC 模拟器，羡煞我也，现在 PS5 的用处就只有 25 年游玩道德与法治 6 了。</p>
<p>最近除了玩游戏，其他时候我也会出去旅个游，在朋友圈里面不方便发，我就发在掘金了。每次出去旅游完我都会算一下花了多少钱，果然发现为什么女生都喜欢去旅游了。今年主要是去了黄山，宁波，苏州和杭州的一些地方，有些是自己去的，有些是和家人一起去的，不论怎么样，天大地大，家人最大。</p>
<p><img src="https://hexo-1304698044.cos.ap-shanghai.myqcloud.com/blog/image-20241221224342438.png" alt="null"><img src="https://cdn.nlark.com/yuque/0/2025/png/27175151/1737724438198-cea3070b-1552-47cf-98e2-735c417399fc.png" alt="img"></p>
<h2 id="总结">总结</h2>
<p>我感觉2024年就是一个持续迭代的过程，当然在我这个年龄只要耐*就有无限可以尝试的机会，我还算年轻，还好年轻。</p>
<p>所以我在2025年制定了以下几个目标，方便我做目标管理，最终做到以终为始，有始有终。</p>
<ul>
<li>学习篇：1、学习dubbo源码、spring boot源码，赋能原有公司的框架开发，做到有落地项目；2、学会C#/nodejs，至少可以做到能进行一些简单界面开发3、继续输出技术文档，可以做到2025年发布12篇4、看书：非开发：《小米创业思考》、《态度改变与社会影响》、《精力管理》、《金字塔原理》、《Personal development for smart people》、《原则》、《学会提问》开发：《quarkus CookBook》、《重构：改善既有代码的设计》、《编程珠玑》、《穷爸爸富爸爸》、《人月神话》、《高性能MySQL》、《架构整洁之道》争取做到一个月可以阅读完一本书，且可以真正的将书中看到的学到的进行实践，记录下来效果。5、挑一个开源项目，或者自己维护一个开源项目（既然学习完源码，不仅能在工作中有效果，也要在副业上有效果）</li>
<li>工作篇：1、考证书，公司内提供了一些行业级别证书，5月参加考试2、软考高级架构师拿下</li>
<li>生活篇：1、跑步300km，每周至少4次运动，明确一个对当前体重合适有效的训练方式。2、去华南旅游一次，去西北旅游一次，去西南旅游一次（当然在我有点钱的情况下）3、入手一辆好一点的公路自行车，准备一下全年的骑行计划。4、多去视频网站上面学习一下英语，具体精确到可以看一些海外技术书籍基本无压力5、多接触其他人，拓宽自己的社交圈子。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E5%BC%80%E5%8F%91/5.easy%20excel%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E4%BB%BB%E6%84%8F%E8%A1%A8%E7%9A%84Excel%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E5%BC%80%E5%8F%91/5.easy%20excel%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E4%BB%BB%E6%84%8F%E8%A1%A8%E7%9A%84Excel%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/" class="post-title-link" itemprop="url">Spring boot整合easy excel实现低代码量的Excel导入导出</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:24:05 / 修改时间：23:16:11" itemprop="dateCreated datePublished" datetime="2025-07-12T12:24:05+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Java的web开发需要excel的导入导出工具，所以需要一定的工具类实现，如果是使用easypoi、Hutool导入导出excel，会非常的损耗内存，因此可以尝试使用easyexcel解决大数据量的数据的导入导出，且可以通过Java8的函数式编程解决该问题。</p>
<p>使用easyexcel，虽然不太会出现OOM的问题，但是如果是大数据量的情况下也会有一定量的内存溢出的风险，所以我打算从以下几个方面优化这个问题：</p>
<ul>
<li>使用Java8的函数式编程实现低代码量的数据导入</li>
<li>使用反射等特性实现单个接口导入任意excel</li>
<li>使用线程池实现大数据量的excel导入</li>
</ul>
<!---->
<ul>
<li>通过泛型实现数据导出</li>
</ul>
<h2 id="maven导入">maven导入</h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--EasyExcel相关依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easyexcel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="使用泛型实现对象的单个Sheet导入">使用泛型实现对象的单个Sheet导入</h2>
<h3 id="先实现一个类，用来指代导入的特定的对象">先实现一个类，用来指代导入的特定的对象</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(&quot;stu_info&quot;)</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;学生信息&quot;)</span></span><br><span class="line"><span class="comment">//@ExcelIgnoreUnannotated 没有注解的字段都不转换</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StuInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 姓名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 设置字体，此处代表使用斜体</span></span><br><span class="line"><span class="comment">//    @ContentFontStyle(italic = BooleanEnum.TRUE)</span></span><br><span class="line">    <span class="comment">// 设置列宽度的注解,注解中只有一个参数value，value的单位是字符长度，最大可以设置255个字符</span></span><br><span class="line">    <span class="meta">@ColumnWidth(10)</span></span><br><span class="line">    <span class="comment">// @ExcelProperty 注解中有三个参数value,index,converter分别代表表名，列序号，数据转换方式</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;姓名&quot;)</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;姓名&quot;,order = 0)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;姓名&quot;,index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 年龄</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @ExcelIgnore不将该字段转换成Excel</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;年龄&quot;,order = 1)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;年龄&quot;)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;年龄&quot;,index = 2)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 身高</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//自定义格式-位数</span></span><br><span class="line"><span class="comment">//    @NumberFormat(&quot;#.##%&quot;)</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;身高&quot;,order = 2)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;身高&quot;)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;身高&quot;,index = 4)</span></span><br><span class="line">    <span class="keyword">private</span> Double tall;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自我介绍</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;自我介绍&quot;,order = 3)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;自我介绍&quot;)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;自我介绍&quot;,index = 3,ignore = true)</span></span><br><span class="line">    <span class="keyword">private</span> String selfIntroduce;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;图片信息&quot;,order = 4)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;图片信息&quot;)</span></span><br><span class="line">    <span class="meta">@ExportHeader(value = &quot;图片信息&quot;,ignore = true)</span></span><br><span class="line">    <span class="keyword">private</span> Blob picture;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;性别&quot;,order = 5)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;性别&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 入学时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//自定义格式-时间格式</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(&quot;yyyy-MM-dd HH:mm:ss:&quot;)</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;入学时间&quot;,order = 6)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;入学时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String intake;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出生日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;出生日期&quot;,order = 7)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;出生日期&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String birthday;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="重写ReadListener接口">重写ReadListener接口</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadDataListener</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">ReadListener</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每隔5条存储数据库，实际使用中可以100条，然后清理list ，方便内存回收</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BATCH_COUNT</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; cachedDataList = ListUtils.newArrayListWithExpectedSize(BATCH_COUNT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Predicate用于过滤数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Predicate&lt;T&gt; predicate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用持久层批量保存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Consumer&lt;Collection&lt;T&gt;&gt; consumer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UploadDataListener</span><span class="params">(Predicate&lt;T&gt; predicate, Consumer&lt;Collection&lt;T&gt;&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.predicate = predicate;</span><br><span class="line">        <span class="built_in">this</span>.consumer = consumer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UploadDataListener</span><span class="params">(Consumer&lt;Collection&lt;T&gt;&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.consumer = consumer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果使用了spring,请使用这个构造方法。每次创建Listener的时候需要把spring管理的类传进来</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> demoDAO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个每一条数据解析都会来调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    one row value. Is is same as &#123;<span class="doctag">@link</span> AnalysisContext#readRowHolder()&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(T data, AnalysisContext context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (predicate != <span class="literal">null</span> &amp;&amp; !predicate.test(data)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cachedDataList.add(data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 达到BATCH_COUNT了，需要去存储一次数据库，防止数据几万条数据在内存，容易OOM</span></span><br><span class="line">        <span class="keyword">if</span> (cachedDataList.size() &gt;= BATCH_COUNT) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 执行具体消费逻辑</span></span><br><span class="line">                consumer.accept(cachedDataList);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                log.error(<span class="string">&quot;Failed to upload data!data=&#123;&#125;&quot;</span>, cachedDataList);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 存储完成清理 list</span></span><br><span class="line">            cachedDataList = ListUtils.newArrayListWithExpectedSize(BATCH_COUNT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有数据解析完成了 都会来调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterAllAnalysed</span><span class="params">(AnalysisContext context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里也要保存数据，确保最后遗留的数据也存储到数据库</span></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(cachedDataList)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 执行具体消费逻辑</span></span><br><span class="line">                consumer.accept(cachedDataList);</span><br><span class="line">                log.info(<span class="string">&quot;所有数据解析完成！&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                log.error(<span class="string">&quot;Failed to upload data!data=&#123;&#125;&quot;</span>, cachedDataList);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 抛出自定义的提示信息</span></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BizException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Controller层的实现">Controller层的实现</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;只需要一个readListener，解决全部的问题&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;String&gt; <span class="title function_">aListener4AllExcel</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            EasyExcel.read(file.getInputStream(),</span><br><span class="line">                            StuInfo.class,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">UploadDataListener</span>&lt;StuInfo&gt;(</span><br><span class="line">                                    list -&gt; &#123;</span><br><span class="line">                                        <span class="comment">// 校验数据</span></span><br><span class="line"><span class="comment">//                                        ValidationUtils.validate(list);</span></span><br><span class="line">                                        <span class="comment">// dao 保存···</span></span><br><span class="line">                                        <span class="comment">//最好是手写一个，不要使用mybatis-plus的一条条新增的逻辑</span></span><br><span class="line">                                        service.saveBatch(list);</span><br><span class="line">                                        log.info(<span class="string">&quot;从Excel导入数据一共 &#123;&#125; 行 &quot;</span>, list.size());</span><br><span class="line">                                    &#125;))</span><br><span class="line">                    .sheet()</span><br><span class="line">                    .doRead();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line">            log.error(<span class="string">&quot;导入失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R.success(<span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>但是这种方式只能实现已存对象的功能实现，如果要新增一种数据的导入，那我们需要怎么做呢？</p>
<p>可以通过读取成Map，根据顺序导入到数据库中。</p>
<h2 id="通过实现单个Sheet中任意一种数据的导入">通过实现单个Sheet中任意一种数据的导入</h2>
<h3 id="Controller层的实现-2">Controller层的实现</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@ApiOperation(&quot;只需要一个readListener，解决全部的问题&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/listenMapDara&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;String&gt; <span class="title function_">listenMapDara</span><span class="params">(<span class="meta">@ApiParam(value = &quot;表编码&quot;, required = true)</span></span></span><br><span class="line"><span class="params">                                   <span class="meta">@NotBlank(message = &quot;表编码不能为空&quot;)</span></span></span><br><span class="line"><span class="params">                                   <span class="meta">@RequestParam(&quot;tableCode&quot;)</span> String tableCode,</span></span><br><span class="line"><span class="params">                                   <span class="meta">@ApiParam(value = &quot;上传的文件&quot;, required = true)</span></span></span><br><span class="line"><span class="params">                                   <span class="meta">@NotNull(message = &quot;上传文件不能为空&quot;)</span> MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//根据tableCode获取这张表的字段，可以作为insert与剧中的信息</span></span><br><span class="line">            EasyExcel.read(file.getInputStream(),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">NonClazzOrientedListener</span>(</span><br><span class="line">                                    list -&gt; &#123;</span><br><span class="line">                                        <span class="comment">// 校验数据</span></span><br><span class="line"><span class="comment">//                                        ValidationUtils.validate(list);</span></span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// dao 保存···</span></span><br><span class="line">                                        log.info(<span class="string">&quot;从Excel导入数据一共 &#123;&#125; 行 &quot;</span>, list.size());</span><br><span class="line">                                    &#125;))</span><br><span class="line">                    .sheet()</span><br><span class="line">                    .doRead();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;导入失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R.success(<span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="重写ReadListener接口-2">重写ReadListener接口</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NonClazzOrientedListener</span> <span class="keyword">implements</span> <span class="title class_">ReadListener</span>&lt;Map&lt;Integer, String&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每隔5条存储数据库，实际使用中可以100条，然后清理list ，方便内存回收</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BATCH_COUNT</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;Object&gt;&gt; rowsList = ListUtils.newArrayListWithExpectedSize(BATCH_COUNT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; rowList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Predicate用于过滤数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Predicate&lt;Map&lt;Integer, String&gt;&gt; predicate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用持久层批量保存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Consumer&lt;List&gt; consumer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NonClazzOrientedListener</span><span class="params">(Predicate&lt;Map&lt;Integer, String&gt;&gt; predicate, Consumer&lt;List&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.predicate = predicate;</span><br><span class="line">        <span class="built_in">this</span>.consumer = consumer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NonClazzOrientedListener</span><span class="params">(Consumer&lt;List&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.consumer = consumer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加deviceName标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Map&lt;Integer, String&gt; row, AnalysisContext analysisContext)</span> &#123;</span><br><span class="line">        consumer.accept(rowsList);</span><br><span class="line">        rowList.clear();</span><br><span class="line">        row.forEach((k, v) -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;key is &#123;&#125;,value is &#123;&#125;&quot;</span>, k, v);</span><br><span class="line">            rowList.add(v == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : v);</span><br><span class="line">        &#125;);</span><br><span class="line">        rowsList.add(rowList);</span><br><span class="line">        <span class="keyword">if</span> (rowsList.size() &gt; BATCH_COUNT) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;执行存储程序&quot;</span>);</span><br><span class="line">            log.info(<span class="string">&quot;rowsList is &#123;&#125;&quot;</span>, rowsList);</span><br><span class="line">            rowsList.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterAllAnalysed</span><span class="params">(AnalysisContext analysisContext)</span> &#123;</span><br><span class="line">        consumer.accept(rowsList);</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(rowsList)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;执行最后的程序&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;rowsList is &#123;&#125;&quot;</span>, rowsList);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                log.error(<span class="string">&quot;Failed to upload data!data=&#123;&#125;&quot;</span>, rowsList);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 抛出自定义的提示信息</span></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BizException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;导入失败&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                rowsList.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这种方式可以通过把表中的字段顺序存储起来，通过配置数据和字段的位置实现数据的新增，那么如果出现了导出数据模板/手写excel的时候顺序和导入的时候顺序不一样怎么办？</p>
<p>可以通过读取header进行实现，通过表头读取到的字段，和数据库中表的字段进行比对，只取其中存在的数据进行排序添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里会一行行的返回头</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeHead</span><span class="params">(Map&lt;Integer, ReadCellData&lt;?&gt;&gt; headMap, AnalysisContext context)</span> &#123;</span><br><span class="line">        <span class="comment">//该方法必然会在读取数据之前进行</span></span><br><span class="line">        Map&lt;Integer, String&gt; columMap = ConverterUtils.convertToStringMap(headMap, context);</span><br><span class="line">        <span class="comment">//通过数据交互拿到这个表的表头</span></span><br><span class="line"><span class="comment">//        Map&lt;String,String&gt; columnList=dao.xxxx();</span></span><br><span class="line">        Map&lt;String, String&gt; columnList = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        columMap.forEach((key, value) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (columnList.containsKey(value)) &#123;</span><br><span class="line">                filterList.add(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//过滤到了只存在表里面的数据，顺序就不用担心了，可以直接把filterList的数据用于排序，可以根据mybatis做一个动态sql进行应用</span></span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;解析到一条头数据:&#123;&#125;&quot;</span>, JSON.toJSONString(columMap));</span><br><span class="line">        <span class="comment">// 如果想转成成 Map&lt;Integer,String&gt;</span></span><br><span class="line">        <span class="comment">// 方案1： 不要implements ReadListener 而是 extends AnalysisEventListener</span></span><br><span class="line">        <span class="comment">// 方案2： 调用 ConverterUtils.convertToStringMap(headMap, context) 自动会转换</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那么这些问题都解决了，如果出现大数据量的情况，如果要极大的使用到cpu，该怎么做呢？</p>
<p>可以尝试使用线程池进行实现</p>
<h2 id="使用线程池进行多线程导入大量数据">使用线程池进行多线程导入大量数据</h2>
<p>Java中线程池的开发与使用与原理我可以单独写一篇文章进行讲解，但是在这边为了进行好的开发我先给出一套固定一点的方法。</p>
<p>由于ReadListener不能被注册到IOC容器里面，所以需要在外面开启</p>
<p>详情可见<a target="_blank" rel="noopener" href="https://juejin.cn/post/7251566038524133436?searchId=2024041212522037CB9A6B24BDAA8953E7">Spring Boot通过EasyExcel异步多线程实现大数据量Excel导入,百万数据30秒</a></p>
<h2 id="通过泛型实现对象类型的导出">通过泛型实现对象类型的导出</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">commonExport</span><span class="params">(String fileName, List&lt;T&gt; data, Class&lt;T&gt; clazz, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtil.isEmpty(data)) &#123;</span><br><span class="line">        data = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置标题</span></span><br><span class="line">    fileName = URLEncoder.encode(fileName, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    response.setContentType(<span class="string">&quot;application/vnd.ms-excel&quot;</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Content-disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + fileName + <span class="string">&quot;.xlsx&quot;</span>);</span><br><span class="line">    EasyExcel.write(response.getOutputStream()).head(clazz).sheet(<span class="string">&quot;sheet1&quot;</span>).doWrite(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接使用该方法可以作为公共的数据的导出接口</p>
<p>如果想要动态的下载任意一组数据怎么办呢？可以使用这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportFreely</span><span class="params">(String fileName, List&lt;List&lt;Object&gt;&gt; data, List&lt;List&lt;String&gt;&gt; head, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isEmpty(data)) &#123;</span><br><span class="line">            data = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置标题</span></span><br><span class="line">        fileName = URLEncoder.encode(fileName, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/vnd.ms-excel&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + fileName + <span class="string">&quot;.xlsx&quot;</span>);</span><br><span class="line">        EasyExcel.write(response.getOutputStream()).head(head).sheet(<span class="string">&quot;sheet1&quot;</span>).doWrite(data);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>什么？不仅想一个接口展示全部的数据与信息，还要增加筛选条件？这个后期我可以单独写一篇文章解决这个问题。</p>
<p>今天的分享就到这里了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E5%BC%80%E5%8F%91/13.%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E9%80%A0%E6%88%90%E7%9A%84OOM%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E5%BC%80%E5%8F%91/13.%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E9%80%A0%E6%88%90%E7%9A%84OOM%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">cos因为数据库表造成的OOM问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:20:06 / 修改时间：23:07:24" itemprop="dateCreated datePublished" datetime="2025-07-12T12:20:06+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">问题处理</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1>一、背景</h1>
<p>在测试环境海外白牌eu环境中，cos服务一直不健康；原因是pod.yml中没有配置liveness，导致服务没有被容器重启；</p>
<p>随后查看日志发现服务触发了OOM异常。</p>
<p><img src="https://static.dingtalk.com/media/lQLPJwkt-3sYPN3NAv_NBSuwP6Lr6wzoGM0HYUowtB8sAA_1323_767.png" alt="img"></p>
<h1>二、原因</h1>
<p>使用jmap命令（jmap -dump:format=b,file=heapdump.hprof 1）打印出服务的内存dump文件；</p>
<p>使用MemoryAnalyzer分析dump文件；</p>
<p><img src="https://static.dingtalk.com/media/lQLPJxEH9zQMXN3NAtnNA9SwjIXJL9jlMBcHYUowtFc_AA_980_729.png" alt="img"></p>
<p>发现大对象是ShardingSphereDataSource，查看这个对象的外引用发现是数据库表实例；</p>
<p><img src="https://static.dingtalk.com/media/lQLPJxgi9H2ZXN3NAyTNA16wzlRt4EUlGQIHYUowtFc_Ag_862_804.png" alt="img"></p>
<p><img src="https://static.dingtalk.com/media/lQLPKGSIMFdt7N3NA0fNBSOw7xsuYxHtBBYHYUowtFc_AQ_1315_839.png" alt="img"></p>
<p><img src="https://static.dingtalk.com/media/lQLPJwVFicXXfN3NAubNBaWwH2qLo6haV6wHYUowtFc_Aw_1445_742.png" alt="img"></p>
<p>最终发现table元数据存在47256个结点；查看node中的value发现数据是表名，但是环境内的表最多存在2567+12830=5632张表，很明显47256是异常的；</p>
<p>查看数据库表中对应的cos_video库，发现其中存在50000+的表（没截图了），应该是环境内每日清理过期表的任务执行失败或者没有执行导致的；</p>
<p>删除cos_video库中过期的表问题解决。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E5%BC%80%E5%8F%91/11.Linux%E4%B8%8B%E7%81%AB%E7%84%B0%E5%9B%BE%E6%94%B6%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E5%BC%80%E5%8F%91/11.Linux%E4%B8%8B%E7%81%AB%E7%84%B0%E5%9B%BE%E6%94%B6%E9%9B%86/" class="post-title-link" itemprop="url">Linux下火焰图收集</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:19:56 / 修改时间：23:16:11" itemprop="dateCreated datePublished" datetime="2025-07-12T12:19:56+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">问题处理</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1>Linux下火焰图收集</h1>
<p>java进程</p>
<p>可以选择使用arthas的jprofile命令</p>
<p>linux</p>
<p>使用perf</p>
<p>以centos为例，安装yum install perf</p>
<p>使用perf record -F 99 -g -p 1 — sleep 30采集30秒进程1，每秒采集99次</p>
<p>perf script -i perf.data &gt; perf.script 将火焰图数据转化成解析文件</p>
<p>操作进程中下载FlameGraph，git clone <a target="_blank" rel="noopener" href="https://github.com/brendangregg/FlameGraph.git%EF%BC%9B">https://github.com/brendangregg/FlameGraph.git；</a></p>
<p>进入FlameGraph文件夹后，执行./stackcollapse-perf.pl /var/mount/eu/tcpdump_file/perf.script &gt; perf.folded折叠堆栈信息</p>
<p>使用./flamegraph.pl perf.folded &gt; flamegraph.svg生成火焰图</p>
<p>svg文件在浏览器中打开可以查看CPU开销</p>
<p><img src="https://hexo-1304698044.cos.ap-shanghai.myqcloud.com/blog/image-20250712122131284.png" alt="image-20250712122131284"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E5%BC%80%E5%8F%91/12.NAT%E6%89%93%E6%B4%9E%E5%91%8A%E8%AD%A6CPU%E8%BE%83%E9%AB%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E5%BC%80%E5%8F%91/12.NAT%E6%89%93%E6%B4%9E%E5%91%8A%E8%AD%A6CPU%E8%BE%83%E9%AB%98/" class="post-title-link" itemprop="url">p2p-relay服务CPU高</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:19:56 / 修改时间：23:07:20" itemprop="dateCreated datePublished" datetime="2025-07-12T12:19:56+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">问题处理</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1>一、背景</h1>
<p>国内宇视p2p-relay服务CPU利用率一直很高，造成服务被liveness杀死，或者内置的P2P控件抢占不到CPU而崩溃。</p>
<p><img src="https://static.dingtalk.com/media/lQLPJwp1Zotqx-HNASLNA9ewCHGYC1e1EGYIMMyulzeVAA_983_290.png" alt="img"></p>
<p>P2P奔溃堆栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2025</span>-<span class="number">03</span>-<span class="number">14</span> <span class="number">16</span>:<span class="number">27</span>:<span class="number">38.070</span> [34mINFO[<span class="number">0</span>;39m [Thread-<span class="number">53990888</span>] [CLoggerImpl.pFnLogFun: <span class="number">45</span>] [] - [p2p control] level: <span class="number">3</span>, message: [7f16197f0700][libcloud.c:<span class="number">7145</span>]StartStream timeout. [50396A31-<span class="number">6769</span>-5A37-<span class="number">5659</span>-626251566B6A]</span><br><span class="line"><span class="number">2025</span>-<span class="number">03</span>-<span class="number">14</span> <span class="number">16</span>:<span class="number">27</span>:<span class="number">38.071</span> [34mINFO[<span class="number">0</span>;39m [Thread-<span class="number">53990889</span>] [CLoggerImpl.pFnLogFun: <span class="number">45</span>] [] - [p2p control] level: <span class="number">3</span>, message: [7f16197f0700][libcloud.c:<span class="number">7573</span>][ConnectPeerDone] iTaskType(<span class="number">2</span>), iIsSUccess(<span class="number">0</span>), pcPeerID(50396A31-<span class="number">6769</span>-5A37-<span class="number">5659</span>-626251566B6A), pcPeerIP(<span class="number">222.222</span><span class="number">.30</span><span class="number">.55</span>), iPeerPort(<span class="number">29433</span>)<span class="number">.2025</span>-<span class="number">03</span>-<span class="number">14</span> <span class="number">16</span>:<span class="number">27</span>:<span class="number">38.078</span> [34mINFO[<span class="number">0</span>;39m [http-nio-<span class="number">8998</span>-exec-<span class="number">515</span>] [CLoggerImpl.pFnLogFun: <span class="number">45</span>] [] - [p2p control] level: <span class="number">3</span>, message: [7f15f4dc4700][t2u_runner.c:<span class="number">265</span>]Failed to call epoll wait, ret[<span class="number">0</span>], errno[<span class="number">2</span>]<span class="number">2025</span>-<span class="number">03</span>-<span class="number">14</span> <span class="number">16</span>:<span class="number">27</span>:<span class="number">38.079</span> [34mINFO[<span class="number">0</span>;39m [http-nio-<span class="number">8998</span>-exec-<span class="number">515</span>] [CLoggerImpl.pFnLogFun: <span class="number">45</span>] [] - [p2p control] level: <span class="number">6</span>, message: [7f15f4dc4700][libcloud.c:<span class="number">5662</span>]MTU probe.## A fatal error has been detected by the Java Runtime Environment:##  SIGSEGV (<span class="number">0xb</span>) at pc=<span class="number">0x00007f161e0757f3</span>, pid=<span class="number">1</span>, tid=<span class="number">0x00007f15f4dc4700</span>## JRE version: Java(TM) SE Runtime <span class="title function_">Environment</span> <span class="params">(<span class="number">8.0_231</span>-b11)</span> (build <span class="number">1.8</span><span class="number">.0_231</span>-b11)# Java VM: Java <span class="title function_">HotSpot</span><span class="params">(TM)</span> <span class="number">64</span>-Bit Server <span class="title function_">VM</span> <span class="params">(<span class="number">25.231</span>-b11 mixed mode linux-amd64 compressed oops)</span># Problematic frame:# C  [libtunnel_new.so+<span class="number">0x607f3</span>]  Libcloud_CreateT2URelation+<span class="number">0x313</span>## Core dump written. Default location: <span class="comment">//core or core.1## An error report file with more information is saved as:# //hs_err_pid1.log## If you would like to submit a bug report, please visit:#    http://bugreport.java.com/bugreport/crash.jsp# The crash happened outside the Java Virtual Machine in native code.# See problematic frame for where to report the bug.#</span></span><br><span class="line">[error occurred during error reporting , id <span class="number">0xb</span>]</span><br><span class="line">[error occurred during error reporting , id <span class="number">0xb</span>]</span><br><span class="line">[error occurred during error reporting , id <span class="number">0xb</span>]</span><br><span class="line">[error occurred during error reporting , id <span class="number">0xb</span>]</span><br><span class="line">[error occurred during error reporting , id <span class="number">0xb</span>]</span><br></pre></td></tr></table></figure>
<h1>二、分析</h1>
<ol>
<li>
<p>CPU高主要是pid为1的java进程占用的，也就是p2p-relay的服务</p>
</li>
<li>
<p>使用top -H，查看线程号为8/9/10/11的线程CPU使用率的特别高</p>
<p><img src="https://static.dingtalk.com/media/lQLPJyEEsQp-umHNAe3NA0awpXOt-G5e-agIMMy0Rr3UAA_838_493.png" alt="img"></p>
</li>
<li>
<p>jstack 1查看线程8/9/10/11对应着四个ParalLelGC并行垃圾回收器（CPU 4核会存在4个垃圾回收器线程）；<br>
垃圾回收器线程为什么会CPU高，说明有大量的对象在被创建/没有引用/被回收持续往复</p>
<p><img src="https://static.dingtalk.com/media/lQLPJxAkl5-TIGHNAjrNBB6wo2BDlT7UQzsIMMy6XeGSAA_1054_570.png" alt="img"></p>
</li>
<li>
<p>使用arthas的dashboard命令查看，young gc出现了289W次，持续了8小时（进程启动了25小时)，再次确认有大量的对象在被创建</p>
<p><img src="https://static.dingtalk.com/media/lQLPKGcFvqLaE-HM780GJLAVVKFCK0EeRggwzMFVEBgA_1572_239.png" alt="img"></p>
</li>
<li>
<p>使用jstat -gc <pid> 1000 | awk ‘{print $6}’ 观察 Eden 分配速率，发现每隔几秒采集就有大量Eden对象创建（单位是kb）；也就是说时时刻刻有2.27G的对象产生<br>
大量对象产生说明业务中存在很大的并发的业务；结合p2p-relay流程，怀疑是接口/pr/device/p2p/invoke接口调用的频发；<br>
但是TOMCAT的http-nio线程并不多，说明请求量并没有很大</p>
<p><img src="https://static.dingtalk.com/media/lQLPKeTTUkwXLGHNAjLNA1ywsht0Yg96qfsIMMzMp_-PAA_860_562.png" alt="img"></p>
</li>
<li>
<p>重新梳理流程后，怀疑可能是P2P日志回调导致的问题</p>
<p><img src="https://static.dingtalk.com/media/lQLPJw0GDi98veHNAlTNAsqwk2HUHEB9gTEIMMzSPo05AA_714_596.png" alt="img"></p>
<p>P2P日志需要java进程给P2P配置回调接口，P2P将日志回调给java进行打印</p>
</li>
<li>
<p>线上配置的P2P日志level是0，一般不会输出到日志中；<br>
但是回看这个业务，如果回调频繁，岂不是要创建大量的String对象（JNA 将原生代码（如 C/C++的 char*）传递的字符串转换为 Java 的 String）；为了确认日志回调的量，将level设置为8，在日志采集服务中发现P2P产生的日志是其他所有服务加起来的10倍+<br>
那问题基本确认就是这个造成的，将设置回调的函数注释掉，并重新部署</p>
</li>
</ol>
<h1>三、修改效果</h1>
<p>修改后效果明显，CPU利用率下降到20%</p>
<p><img src="E:%5CBlogin%5Cprojects-markdown%5C%E5%90%8E%E7%AB%AF%5CJava%E6%8A%80%E6%9C%AF%5Cb04caed56a1b9bf1e2cdc1d0555f1043.png" alt="b04caed56a1b9bf1e2cdc1d0555f1043"></p>
<h1>四、优化方向</h1>
<p>建议P2P库优化方向：</p>
<p>P2P的日志level控制由P2P侧实现，云端下发日志的level；P2P库整理下日志，尽量减少日志，精简下。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E5%BC%80%E5%8F%91/9.flyway%E5%8F%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E5%88%B0%E5%BD%93%E5%89%8D%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E5%BC%80%E5%8F%91/9.flyway%E5%8F%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E5%88%B0%E5%BD%93%E5%89%8D%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" class="post-title-link" itemprop="url">flyway可否使用到当前开发环境</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:14:50 / 修改时间：23:16:11" itemprop="dateCreated datePublished" datetime="2025-07-12T12:14:50+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>Flyway是什么？</p>
</blockquote>
<p>Flyway是一款开源的数据库版本管理工具，可以实现管理并跟踪数据库变更，支持数据库版本自动升级，而且不需要复杂的配置，能够帮助团队更加方便、合理的管理数据库变更。<br>
例：创建两个sql变更文件，项目启动后会将两个文件中的sql语句全部执行。</p>
<h1>1、痛点</h1>
<ol>
<li>每次封板都要执行一次数据库，很久没更新的环境中，数据库都需要做到到处找sql文件进行执行，很麻烦</li>
</ol>
<h1>2、优点</h1>
<p>Flyway可以在微服务上线时自动执行SQL脚本，不需要再执行工单</p>
<h1>3、为什么不用Flyway</h1>
<h2 id="3-1、对于开发">3.1、对于开发</h2>
<ol>
<li>有些微服务提早上线，但是也会同时更新在主干分支中，所以用一个修改会存在于多个版本中，上线到同一个环境中时会出问题</li>
<li>分库分表虽然支持Flyway，但是复杂度高，容易出问题，开发与拓展均较难完全验证</li>
<li>每个涉及到数据库的微服务都要配置一组Flyway的参数，对于运维也不友好</li>
<li>微服务拆分与合并，flyway则需要额外投入人力进行开发</li>
</ol>
<h2 id="3-2、对于运维">3.2、对于运维</h2>
<ol>
<li>Flyway本质上是使用微服务自己的资源执行SQL语句，在<strong>常规场景</strong>下对微服务和MySQL的资源消耗可控，但在<strong>大规模数据迁移或复杂DDL操作</strong>时需重点优化，这在使用DMS的时候，只需要运维保证不影响线上环境的MySQL即可</li>
<li>虽然Flyway也有版本工具，如果线上出问题，DMS可以直接提工单进行执行，但是Flyway则需要重新配置执行规则，走上线流程，比较消耗人力</li>
<li>如果是pod集群使用，则需要额外配置Kubernetes Job，这才能保证多个pod启动时避免出问题</li>
</ol>
<h2 id="4、原有痛点解决方式">4、原有痛点解决方式</h2>
<p>删除对应环境对应数据库的表，重新使用ddl进行创建</p>
<h2 id="推荐阅读">推荐阅读</h2>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Jiao1225/article/details/129590660">Flyway详解（使用说明及避坑指南、一文搞懂flyway）</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7308219677805051955">数据库/SQL 版本管理工具选型指北：Flyway、Liquibase、Bytebase、阿里 DMS</a></li>
<li><a target="_blank" rel="noopener" href="https://www.red-gate.com/products/flyway/community/">flyway官网</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Flying_Fish_roe/article/details/142418042">Flyway 常见问题与解决方案</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1489916">【SpringBoot系列】微服务集成Flyway</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E5%BC%80%E5%8F%91/8.%E6%97%A5%E5%BF%97%E5%88%B0%E5%BA%95%E6%80%8E%E4%B9%88%E6%89%93%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E5%BC%80%E5%8F%91/8.%E6%97%A5%E5%BF%97%E5%88%B0%E5%BA%95%E6%80%8E%E4%B9%88%E6%89%93%EF%BC%9F/" class="post-title-link" itemprop="url">日志到底该怎么打？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:14:50 / 修改时间：23:16:11" itemprop="dateCreated datePublished" datetime="2025-07-12T12:14:50+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[TOC]</p>
<p>一般写Java服务端的基本上都使用spring框架，使用spring项目则代表一般会用<strong>slf4j</strong>作为打印日志的配置标准。很多时候不是在开发中直接打印日志就好了，日志还兼具着调试，线上排查问题等功能。</p>
<p>且slf4j有以下的一个日志等级</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug(调试 ) &lt; info(消息) &lt; warn(警告) &lt; error(错误) &lt; fatal(严重错误)</span><br></pre></td></tr></table></figure>
<p>背景为：在开发过程中，组长认为我写的日志不是很好</p>
<p>目的为：期望我可以使用比较好的开发习惯，在开发过程中，期望我使用最少的精力写出方便开发者做调试，以及线上进行查看的日志。</p>
<p>因此我打算使用以下配置作为开发者的一个习惯配置做培养</p>
<h1>1、logback.xml配置</h1>
<p>这个文件用于存储具体日志打印的配置。当然也有第三方日志打印/暴露endpoint以别的配置文件打印到别的目录下。基本上不会修改这个文件中的配置，除非出现问题，要求修改第三方包的日志的等级等情况才会进行修改。</p>
<h1>2、是否该打印日志</h1>
<p>打印日志主要是为了一下几种原因：</p>
<ol>
<li>
<p><strong>调试：</strong></p>
<p>开发过程中需要实时看到参数信息、业务流程分支等信息，在spring中，一些异步调用，生命周期、事件、队列消费等信息不会主动触发到，顾需要日志来显式展示配置信息、或者定位信息</p>
<p>开发过程中遇到用户出现了业务上的失败流程，但是不会影响整个业务，不会影响进程安全的信息，也会需要打印出来，用于辅助调试</p>
</li>
<li>
<p><strong>排查问题：</strong></p>
<p>业务上出现了问题，则会要求打印重要参数信息，用于查看配置</p>
</li>
<li>
<p><strong>数据处理</strong>：</p>
<p>如果项目上了新特性，则需要打印对应信息，用于查看用户使用UV、PV，业务路径等信息，这个就是买点上报+数据处理上的流程。</p>
</li>
</ol>
<h1>3、打印日志的级别等级</h1>
<p>打印过程中需要日志足够简洁足够重要。</p>
<p>打印过程中如要打印比较重要的参数，如数据库影响行数，入参等信息</p>
<p>以下是几个比较重要的打印等级的信息</p>
<ol>
<li>
<p>debug：</p>
<p>一般会打印一些调试参数，方便开发者查看业务会走到哪里，在线上一般不会打开这个等级的日志打印。</p>
<p>一些异步调用，生命周期、事件、队列消费等信息不会主动触发，所以也需要debug等级日志打印。</p>
<p>arthas和debug等级日志很大程度上功能重合了，所以为了避免日志冗余，也可以通过使用arthas调试代码。</p>
</li>
<li>
<p>info：</p>
<p>如果是埋点上报信息，则会打印用户id，用户后续的业务点击点等信息。</p>
</li>
<li>
<p>warn：</p>
<p>如果用户在走业务流程时候出现了错误，但是不影响后续的业务流程，则打印这个等级的日志</p>
</li>
<li>
<p>error：</p>
<p>用户在业务流程中出现了严重技术或者业务错误，导致无法继续进行业务，则需要打印这个等级的日志。</p>
</li>
</ol>
<h1>4、怎么依据日志做调试排查</h1>
<h1>0、禁忌：</h1>
<ol>
<li>不要把list直接打印出来，尽量只打印，对外内存容易出现OOM、且虽然是异步打印日志，但是打印大量日志会导致不必要的消耗资源。</li>
<li>很多小伙伴可能用docker、k8s、ELK进行日志收集，所以为了兼容性，只能打印英语日志，打印中文日志很容易会导致乱码</li>
<li>打印日志要保证安全性不能名，不能明文打印敏感信息</li>
<li>不要打印exception对象，要打印e.getMessage()</li>
<li>遇到异常，打印log.error()后就不要在抛出异常了，再抛出异常可能会导致多余日志的打印</li>
</ol>
<p>推荐阅读：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Dream_Weave/article/details/139592062"> 别在 Java 代码里乱打日志了，项目中这样打印日志才足够优雅！</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/12/%E5%BC%80%E5%8F%91/7.code%20review%E6%80%8E%E4%B9%88%E5%81%9A%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="annabergite">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="艾迪的技术之路">
      <meta itemprop="description" content="记录博客与成长,Java，架构">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 艾迪的技术之路">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/12/%E5%BC%80%E5%8F%91/7.code%20review%E6%80%8E%E4%B9%88%E5%81%9A%EF%BC%9F/" class="post-title-link" itemprop="url">code review 怎么做？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-12 12:14:50 / 修改时间：23:16:11" itemprop="dateCreated datePublished" datetime="2025-07-12T12:14:50+08:00">2025-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li>提交合入请求后，仍然需要查看git上面的差异报告，总有一些想不到的地方是有问题的</li>
<li>代码，配置文件，sql需要保证对应的上此次修改，因为要交付给运维使用</li>
<li>尽量使用原有代码逻辑，如单个操作接口转批量操作接口，为避免过度优化，建议调用单个操作接口对应的API实现批量操作接口</li>
<li>sql语句会出现多次修改，需要更新最后修改到何如文件上面；如以下例子，新增一个叫做taskId的字段，并且增加了taskId的索引，但是因为taskId不符合一般的字段明明，所以会将字段改为task_id，但是如果忘记修改新的索引，会导致上线时SQL语句报错</li>
<li>因为是持续交付项目，所以为了保证代码可以持续性，如果要修改某个配置文件的名称，如果像是修改redis-time直接修改为alarm-redis-time，那么旧微服务在更新为新版本微服务时，会出现一段时间的该字段是小问题；正确做法应当是新增一个alarm-redis-time属性供新版本微服务在未来使用，redis-time则备注在下一个迭代删除</li>
<li>配置文件尽量不新增，减少运维工作量</li>
<li>日志尽量少打，因为大量日志会导致检索服务花费大，且导致过度消耗CPU；打印日志时，需要将入参，当前业务涉及对象进行打印，避免线上出问题导致无法排查</li>
<li>进行业务开发，需要将大的业务步骤之间进用空格分隔，并且使用备注表明逻辑；整个的逻辑链路需要做到口述出来</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">annabergite</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

  <script type="text/javascript" src='https://unpkg.com/mermaid@9.0.0/dist/mermaid.min.js'></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: '[object Object]',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  
    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
